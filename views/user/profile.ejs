<%- include("../../views/partials/user/sidebarProfile") %>

                <!-- Main Content Area -->
                <div class="col-lg-8">
                    <!-- User Details Card -->
                   <div class="card mb-4" id="userDetails">
                        <div class="card-body">
                            <h3 class="card-title">User Profile</h3>
                            
                            <div class="user-info-section">
                                <!-- Profile Image Section -->
                                <div class="profile-image-container">
                                    <div id="profileImageDisplay" class="profile-image-placeholder" onclick="triggerFileInput()">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    
                                    <div class="image-actions">
                                        <button class="image-action-btn edit-btn" onclick="triggerFileInput()" title="Edit Image">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                        <button class="image-action-btn delete-btn" onclick="deleteProfileImage()" title="Delete Image">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    
                                    <input type="file" id="profileImageInput" class="file-input" accept="image/*" onchange="handleImageUpload(event)">
                                </div>

                                <!-- User Details -->
                            <div class="container mt-5">
        <div class="card mb-4">
            <div class="card-body">
                <h4 class="card-title mb-4">User Profile</h4>
                
             <form onsubmit="submitEditProfile(event,'<%=user?._id %>')">

                    <div class="mb-3">
                        <label for="firstName" class="form-label">
                            <i class="fas fa-user me-1"></i> Full Name
                        </label>
                        <input type="text" class="form-control" id="firstName" name="names" value="<%=user?.name %>" required />
                        <div id="firstNameMessage" class="text-danger"></div>
                    </div>

                    <div class="mb-3">
                        <label for="email" class="form-label">
                            <i class="fas fa-envelope me-1"></i> Email
                        </label>
                        <input type="email" class="form-control" id="email" name="email" value="<%= user?.email %>" readonly />
                    </div>

                    <div class="mb-3">
                        <label for="mobile" class="form-label">
                            <i class="fas fa-mobile-alt me-1"></i> Mobile
                        </label>
                        <input type="text" class="form-control" id="mobile" name="phone" value="<%= user?.phone %>" required />
                        <div id="mobileMessage" class="text-danger"></div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> Save Changes
                    </button>
                </form>
            </div>
        </div>
    </div>


                    <!-- Edit Profile Form -->
                    <div class="card mb-4" id="profileForm" style="display: none">
                        <div class="card-body">
                            <h5 class="card-title">Update Profile</h5>
                           <form onsubmit="updateProfile(event)">
  <div class="mb-3">
    <label class="form-label"><i class="fas fa-user me-1"></i> Full Name</label>
    <input type="text" class="form-control" id="firstName" name="name" value="<%= user?.name %>" required>
  </div>

  <div class="mb-3">
    <label class="form-label"><i class="fas fa-mobile-alt me-1"></i> Mobile</label>
    <input type="text" class="form-control" id="mobile" name="phone" value="<%= user?.phone %>" required>
  </div>

  <button type="submit" class="btn btn-primary">
    <i class="fas fa-save me-1"></i> Save Changes
  </button>
</form>

                                
                        </div>
                    </div>

                    <!-- Address Management -->
                    <div class="card mb-4" id="addressDetails" style="display: none">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0">Address Details</h5>
                                <button class="btn btn-primary btn-sm" onclick="showAddAddressForm()">
                                    <i class="fas fa-plus me-1"></i> Add New Address
                                </button>
                            </div>
                            <div id="addressList">
                                <!-- Sample addresses -->
                                <div class="address-item border rounded p-3 mb-3">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <strong>Home Address</strong><br>
                                            John Doe<br>
                                            123 Main Street, Apartment 4B<br>
                                            New York, NY 10001<br>
                                            Phone: +91 9876543210
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <button class="btn btn-outline-primary btn-sm me-2">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Section -->
                    <div class="card mb-4" id="orderDetails" style="display: none">
                        <div class="card-body">
                            <h5 class="card-title">Order History</h5>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Payment Method</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ordersTableBody">
                                        <!-- Sample orders -->
                                        <tr>
                                            <td>
                                                #ORD001
                                                <br><br>
                                                <a href="#" class="invoice-btn">
                                                    <i class="fas fa-download me-1"></i> Download Invoice
                                                </a>
                                            </td>
                                            <td>Credit Card</td>
                                            <td>₹1,299</td>
                                            <td><span class="status-badge status-delivered">Delivered</span></td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="action-button btn btn-outline-primary btn-sm">View Order</button>
                                                    <button class="action-button return-button btn btn-outline-warning btn-sm">Return</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>#ORD002</td>
                                            <td>UPI</td>
                                            <td>₹899</td>
                                            <td><span class="status-badge status-pending">Pending</span></td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="action-button btn btn-outline-primary btn-sm">View Order</button>
                                                    <button class="action-button btn btn-outline-danger btn-sm">Cancel</button>
                                                    <button class="action-button btn btn-outline-success btn-sm">Pay Now</button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Wallet History Table -->
                    <div class="table-container" id="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th colspan="3" class="balance-row">
                                        Total Balance: ₹<span id="walletBalance"><%= user?.wallet %></span>
 
                                    </th>
                                </tr>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody id="walletHistoryBody">
  <% if(user?.walletHistory && user?.walletHistory.length > 0) { %>
    <% user?.walletHistory.forEach(txn => { %>
      <tr>
        <td><%= txn.date.toISOString().split('T')[0] %></td>
        <td style="color: <%= txn.amount >= 0 ? '#28a745' : '#dc3545' %>; font-weight: bold;">
          <%= txn.amount >= 0 ? '+' : '-' %>₹<%= Math.abs(txn.amount) %>
        </td>
        <td><%= txn.description %></td>
      </tr>
    <% }) %>
  <% } else { %>
    <tr>
      <td colspan="3" class="text-center">No transactions found</td>
    </tr>
  <% } %>
</tbody>

                        </table>
                    </div>
                </div>

                    <!-- Fixed Wallet Section -->
                    <div class="card wallet-card">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-wallet"></i>
                                My Wallet
                            </h2>
                            
                            <div class="wallet-balance-label">Available Balance</div>
                            <h3 class="wallet-balance">
                                <i class="fas fa-rupee-sign"></i>
                                <%=console.log(user)%>
                              <span><%= user?.walletId ? user?.walletId.balance : 0 %></span>

                            </h3>
                            
                            <div class="wallet-actions">
                                <a href="#" class="wallet-btn" onclick="addMoney()">
                                    <i class="fas fa-plus"></i>
                                    Add Money
                                </a>
                                <a href="#" class="wallet-btn" onclick="toggleWalletHistory(event)">
                                    <i class="fas fa-history"></i>
                                    Transaction History
                                </a>
                                <!-- <a href="#" class="wallet-btn" onclick="transferMoney()">
                                    <i class="fas fa-exchange-alt"></i>
                                    Transfer
                                </a> -->
                            </div>
                        </div>
                    </div>

                    <!-- Edit Profile Form -->
                    <div class="card mb-4" id="profileForm" style="display: none">
                        <div class="card-body">
                            <h5 class="card-title">Update Profile</h5>
                            <form onsubmit="updateProfile(event)">
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-user me-1"></i> Full Name</label>
                                    <input type="text" class="form-control" id="firstName" name="name" value="John Doe" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-mobile-alt me-1"></i> Mobile</label>
                                    <input type="text" class="form-control" id="mobile" name="phone" value="+91 9876543210" required>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i> Save Changes
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Address Management -->
                    <div class="card mb-4" id="addressDetails" style="display: none">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0">Address Details</h5>
                                <button class="btn btn-primary btn-sm" onclick="showAddAddressForm()">
                                    <i class="fas fa-plus me-1"></i> Add New Address
                                </button>
                            </div>
                            <div id="addressList">
                                <!-- Sample addresses -->
                                <div class="address-item border rounded p-3 mb-3">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <strong>Home Address</strong><br>
                                            John Doe<br>
                                            123 Main Street, Apartment 4B<br>
                                            New York, NY 10001<br>
                                            Phone: +91 9876543210
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <button class="btn btn-outline-primary btn-sm me-2">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Section -->
                    <div class="card mb-4" id="orderDetails" style="display: none">
                        <div class="card-body">
                            <h5 class="card-title">Order History</h5>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Payment Method</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ordersTableBody">
                                        <!-- Sample orders -->
                                        <tr>
                                            <td>
                                                #ORD001
                                                <br><br>
                                                <a href="#" class="invoice-btn">
                                                    <i class="fas fa-download me-1"></i> Download Invoice
                                                </a>
                                            </td>
                                            <td>Credit Card</td>
                                            <td>₹1,299</td>
                                            <td><span class="status-badge status-delivered">Delivered</span></td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="action-button btn btn-outline-primary btn-sm">View Order</button>
                                                    <button class="action-button return-button btn btn-outline-warning btn-sm">Return</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>#ORD002</td>
                                            <td>UPI</td>
                                            <td>₹899</td>
                                            <td><span class="status-badge status-pending">Pending</span></td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="action-button btn btn-outline-primary btn-sm">View Order</button>
                                                    <button class="action-button btn btn-outline-danger btn-sm">Cancel</button>
                                                    <button class="action-button btn btn-outline-success btn-sm">Pay Now</button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Wallet History Table -->
                    <div class="table-container" id="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th colspan="3" class="balance-row">
                                        Total Balance: ₹<span id="walletBalance"><%= user?.wallet %></span>
 /-
                                    </th>
                                </tr>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                           <tbody id="walletHistoryBody">
  <% if(user?.walletHistory && user?.walletHistory.length > 0) { %>
    <% user?.walletHistory.forEach(txn => { %>
      <tr>
        <td><%= txn.date.toISOString().split('T')[0] %></td>
        <td style="color: <%= txn.amount >= 0 ? '#28a745' : '#dc3545' %>; font-weight: bold;">
          <%= txn.amount >= 0 ? '+' : '-' %>₹<%= Math.abs(txn.amount) %>
        </td>
        <td><%= txn.description %></td>
      </tr>
    <% }) %>
  <% } else { %>
    <tr>
      <td colspan="3" class="text-center">No transactions found</td>
    </tr>
  <% } %>
</tbody>

                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script>
  async function submitEditProfile(event,userId) {
    event.preventDefault();

    const name = document.getElementById("firstName").value.trim();
    const phone = document.getElementById("mobile").value.trim();
  
console.log(name,phone);


    try {
      const response = await fetch("/update-profile", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({userId, name, phone }),
      });

      const result = await response.json();

      if (result.success) {
        swal({
          title: "Success!",
          text: result.message,
          icon: "success",
          timer: 2000,
          buttons: false
        }).then(() => {
          location.reload(); // Or redirect
        });
      } else {
        swal("Failed!", result.message, "error");
      }
    } catch (err) {
      swal("Error!", "Something went wrong", "error");
    }
  }


  async function toggleWalletHistory(event) {
    event.preventDefault(); // Prevents page reload

    try {
      const response = await fetch('/transactionHistory');

      if (!response.ok) {
        throw new Error("Failed to fetch history.");
      }

      const html = await response.text(); // Expecting EJS-rendered HTML from server

      Swal.fire({
        title: 'Transaction History',
        html: html, // Rendered HTML from server
        width: '80%',
        showCloseButton: true,
        showConfirmButton: false,
        customClass: {
          popup: 'wallet-history-popup'
        },
        scrollbarPadding: false
      });

    } catch (err) {
      Swal.fire('Error', err.message, 'error');
    }
  }
</script>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.12/sweetalert2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script