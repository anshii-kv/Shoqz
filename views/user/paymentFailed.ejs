<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Payment Failed - My Store</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
        <style>
            .failure-container {
                background-color: #bddbeb;
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .failure-card {
                border-radius: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                background: white;
                max-width: 600px;
                width: 100%;
                margin: 20px;
            }
            
            .failure-icon {
                width: 120px;
                height: 120px;
                background: linear-gradient(135deg, #ff6b6b, #ee5a52);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto;
                animation: pulse 2s infinite;
                box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
            }
            
            @keyframes pulse {
                0% {
                    transform: scale(1);
                    box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
                }
                50% {
                    transform: scale(1.05);
                    box-shadow: 0 15px 40px rgba(255, 107, 107, 0.4);
                }
                100% {
                    transform: scale(1);
                    box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
                }
            }
            
            .failure-icon i {
                font-size: 3rem;
                color: white;
            }
            
            .failure-title {
                color: #2c3e50;
                font-weight: 700;
                margin-bottom: 15px;
            }
            
            .failure-message {
                color: #6c757d;
                font-size: 1.1rem;
                line-height: 1.6;
                margin-bottom: 30px;
            }
            
            .btn-retry {
                background: linear-gradient(135deg, #007bff, #0056b3);
                border: none;
                padding: 12px 30px;
                border-radius: 25px;
                font-weight: 600;
                transition: all 0.3s ease;
                box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
            }
            
            .btn-retry:hover {
                background: linear-gradient(135deg, #0056b3, #004085);
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0, 123, 255, 0.4);
            }
            
            .btn-order-details {
                background: transparent;
                color: #6c757d;
                border: 2px solid #dee2e6;
                padding: 12px 30px;
                border-radius: 25px;
                font-weight: 600;
                transition: all 0.3s ease;
            }
            
            .btn-order-details:hover {
                background: #f8f9fa;
                border-color: #adb5bd;
                color: #495057;
                transform: translateY(-2px);
            }
            
            .order-info-card {
                background: #f8f9fa;
                border-radius: 15px;
                border-left: 4px solid #ff6b6b;
                margin-top: 30px;
            }
            
            .order-info-title {
                color: #2c3e50;
                font-weight: 600;
                margin-bottom: 10px;
            }
            
            .order-detail {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
                font-size: 0.95rem;
            }
            
            .order-detail:last-child {
                margin-bottom: 0;
                font-weight: 600;
                color: #2c3e50;
                font-size: 1.1rem;
                padding-top: 10px;
                border-top: 2px solid #dee2e6;
            }
            
            .back-to-home {
                position: absolute;
                top: 30px;
                left: 30px;
                color: #6c757d;
                text-decoration: none;
                font-weight: 500;
                transition: color 0.3s ease;
            }
            
            .back-to-home:hover {
                color: #007bff;
            }
            
            .illustration-bg {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                opacity: 0.1;
                background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="%23007bff"/><circle cx="80" cy="20" r="2" fill="%23ff6b6b"/><circle cx="20" cy="80" r="2" fill="%2328a745"/><circle cx="80" cy="80" r="2" fill="%23ffc107"/><circle cx="50" cy="50" r="3" fill="%236c757d"/></svg>');
                z-index: -1;
            }
            
            @media (max-width: 576px) {
                .failure-card {
                    margin: 10px;
                    border-radius: 15px;
                }
                
                .failure-icon {
                    width: 100px;
                    height: 100px;
                }
                
                .failure-icon i {
                    font-size: 2.5rem;
                }
                
                .failure-title {
                    font-size: 1.5rem;
                }
                
                .btn-retry, .btn-order-details {
                    width: 100%;
                    margin-bottom: 10px;
                }
                
                .back-to-home {
                    position: relative;
                    top: auto;
                    left: auto;
                    display: block;
                    text-align: center;
                    margin-bottom: 20px;
                }
            }
        </style>
    </head>
    <body>
        <div class="failure-container">
            <div class="illustration-bg"></div>
            
            <a href="/" class="back-to-home">
                <i class="fas fa-arrow-left me-2"></i>Back to Home
            </a>
            
            <div class="failure-card">
                <div class="card-body p-5 text-center">
                    <!-- Failure Icon/Illustration -->
                    <div class="failure-icon mb-4">
                        <i class="fas fa-times"></i>
                    </div>
                    
                    <!-- Main Message -->
                    <h2 class="failure-title">Payment Failed!</h2>
                    <p class="failure-message">
                        Oops! We couldn't process your payment. Don't worry, your order has been saved 
                        and you can retry the payment or choose a different payment method.
                    </p>
                    
                    <!-- Order Information Card -->
                    <div class="order-info-card p-4 text-start">
                        <h6 class="order-info-title">
                            <i class="fas fa-receipt me-2"></i>Order Information
                        </h6>
                        <div class="order-detail">
                            <span>Order ID:</span>
                            <%=console.log(order.displayOrderId)%>
                            <span class="text-muted"><%=order.displayOrderId%></span>
                        </div>
                            <div class="order-detail">
                                <span>Items:</span>
                                <%=console.log(order.product.length,'hey ansi')%>
                                <span class="text-muted"><%=order.product.length%></span>
                            </div>
                        <div class="order-detail">
                            <span>Payment Method:</span>
                            <span class="text-muted">Razorpay</span>
                        </div>
                        <div class="order-detail">
                            <span>Amount:</span>
                            <span class="text-primary"><%order.product.finalamount%></span>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mt-4">
                        <div class="row gap-3 justify-content-center">
                            <div class="col-md-5 col-12">
                                <button class="btn btn-retry btn-primary w-100" onclick="retryPayment()">
                                    <i class="fas fa-redo me-2"></i>Retry Payment
                                </button>
                            </div>
                            <!-- <div class="col-md-5 col-12">
                                <button class="btn btn-order-details w-100" onclick="viewOrderDetails()">
                                    <i class="fas fa-list-alt me-2"></i>View Order Details
                                </button>
                            </div> -->
                        </div>
                    </div>
                    
                    <!-- Additional Help -->
                    <div class="mt-4 pt-3 border-top">
                        <small class="text-muted">
                            Need help? <a href="/contact" class="text-decoration-none">Contact Support</a> or 
                            <a href="/faq" class="text-decoration-none">View FAQ</a>
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Get order ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            
            // Update order ID in the display
            document.addEventListener('DOMContentLoaded', function() {
                const orderIdElement = document.querySelector('.order-detail span.text-muted');
                if (orderIdElement && orderId) {
                    orderIdElement.textContent = orderId;
                }
            });
            
  const{subtotal,currency,order_id}=data;          
          
// async function retryPayment() {
//     console.log("Retry button clicked");

//     const retryBtn = document.querySelector('.btn-retry');
//     const originalText = retryBtn.innerHTML;
//     retryBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
//     retryBtn.disabled = true;

//     const orderId = '<%= order._id %>'; 
//     console.log(orderId,"here");
//     // EJS variable
// const subtotal = order.subtotal;
//     const userConfirmed = await Swal.fire({
//         title: 'Retry Payment',
//         text: 'You will be redirected to the payment gateway.',
//         icon: 'info',
//         showCancelButton: true,
//         confirmButtonColor: '#007bff',
//         cancelButtonColor: '#6c757d',
//         confirmButtonText: 'Continue',
//         cancelButtonText: 'Cancel'
//     });

//     if (!userConfirmed.isConfirmed) {
//         retryBtn.innerHTML = originalText;
//         retryBtn.disabled = false;
//         return;
//     }

//     try {
//         const res = await fetch('/retryPayment', {
//             method: 'POST',
//             headers: { 'Content-Type': 'application/json' },
//             body: JSON.stringify({ orderId })
//         });

//         const data = await res.json();
// console.log(data,"ammukumaran here");

//         if (data.success) {
//             console.log("datasucees here");
            
//             // Redirect to checkout
//             window.location.href = '/checkout';
//         } else {
//             Swal.fire('Error', data.message || 'Retry failed.', 'error');
//         }
//     } catch (err) {
//         console.error(err);
//         Swal.fire('Error', 'Something went wrong.', 'error');
//     } finally {
//         retryBtn.innerHTML = originalText;
//         retryBtn.disabled = false;
//     }
// }
async function retryPayment() {
    console.log("Retry button clicked");

    const retryBtn = document.querySelector('.btn-retry');
    const originalText = retryBtn.innerHTML;
    retryBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    retryBtn.disabled = true;

    const orderId = '<%= order._id %>'; 

    const userConfirmed = await Swal.fire({
        title: 'Retry Payment',
        text: 'You will be redirected to the payment gateway.',
        icon: 'info',
        showCancelButton: true,
        confirmButtonColor: '#007bff',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Continue',
        cancelButtonText: 'Cancel'
    });

    if (!userConfirmed.isConfirmed) {
        retryBtn.innerHTML = originalText;
        retryBtn.disabled = false;
        return;
    }

    try {
        const res = await fetch('/retryPayment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId })
        });

        const data = await res.json();

        if (data.success) {
            const options = {
                key: data.key,
                amount: data.amount,
                currency: data.currency,
                name: "Your Store Name",
                description: "Order Payment Retry",
                order_id: data.orderId,
                prefill: {
                    name: data.customer.name,
                    email: data.customer.email,
                    contact: data.customer.contact
                },
                theme: {
                    color: "#3399cc"
                },
                handler: function (response) {
                    // Call backend to verify payment
                    fetch('/retryPayment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            // razorpay_payment_id: response.razorpay_payment_id,
                            // razorpay_order_id: response.razorpay_order_id,
                            // razorpay_signature: response.razorpay_signature,
                            // orderId: orderId
                            orderId
                        })
                    })
                    .then(res => res.json())
                    .then(resData => {
                        if (resData.success) {
                            Swal.fire('Success', 'Payment completed successfully!', 'success')
                                .then(() => window.location.href =`/thankyou/orderId${data.orderId}`);
                        } else {
                            Swal.fire('Error', 'Payment verification failed.', 'error');
                        }
                    });
                }
            };

            const rzp = new Razorpay(options);
            rzp.open();
        } else {
            Swal.fire('Error', data.message || 'Retry failed.', 'error');
        }
    } catch (err) {
        console.error(err);
        Swal.fire('Error', 'Something went wrong.', 'error');
    } finally {
        retryBtn.innerHTML = originalText;
        retryBtn.disabled = false;
    }
}




            
            // View order details function
            function viewOrderDetails() {
                // Extract order ID from URL or use default
                const orderIdParam = orderId.replace('#', '');
                
                Swal.fire({
                    title: 'Redirecting...',
                    text: 'Taking you to your order details.',
                    icon: 'info',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    // Redirect to order details page
                    window.location.href = '/order'
                });
            }
            
            // Auto-retry functionality (optional)
            let autoRetryCount = 0;
            const maxAutoRetries = 2;
            
            function autoRetryPayment() {
                if (autoRetryCount < maxAutoRetries) {
                    autoRetryCount++;
                    console.log(`Auto retry attempt ${autoRetryCount}`);
                    
                    // Show auto-retry notification
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'info',
                        title: `Auto-retry attempt ${autoRetryCount}`,
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                    
                    // Attempt to retry payment automatically
                    // This would typically involve calling your payment retry endpoint
                    setTimeout(() => {
                        // If auto-retry fails, show manual retry option
                        if (autoRetryCount >= maxAutoRetries) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Auto-retry failed',
                                text: 'Please try again manually or contact support.',
                                confirmButtonText: 'Manual Retry',
                                showCancelButton: true,
                                cancelButtonText: 'Contact Support'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    retryPayment();
                                } else if (result.dismiss === Swal.DismissReason.cancel) {
                                    window.location.href = '/order';
                                }
                            });
                        }
                    }, 2000);
                }
            }
            
            // Uncomment the line below to enable auto-retry on page load
            // autoRetryPayment();
            
        </script>
        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    </body>
</html>