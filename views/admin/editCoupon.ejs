<%- include("../../views/partials/admin/sidebar") %>
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Shoqz Admin - Edit Coupon</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: "Segoe UI", "Arial", sans-serif;
            }

            body {
                display: flex;
                background: linear-gradient(135deg, #fff 0%, #764ba2 100%);
                min-height: 100vh;
            }

            .main-content {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
            }

            .page-header {
                background-color: white;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .page-title {
                font-size: 2.5rem;
                font-weight: 700;
                background: linear-gradient(135deg, #182f95 0%, #764ba2 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                margin-bottom: 0.5rem;
            }

            .back-button {
                background-color: #777;
                color: white;
                border: none;
                padding: 10px 16px;
                border-radius: 6px;
                font-weight: 500;
                cursor: pointer;
                display: flex;
                align-items: center;
                font-size: 14px;
                transition: all 0.3s ease;
                text-decoration: none;
            }

            .back-button:hover {
                background-color: #666;
                transform: translateY(-2px);
            }

            .back-button i {
                margin-right: 6px;
                font-size: 16px;
            }

            .form-container {
                background-color: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                max-width: 800px;
                margin: 0 auto;
            }

            .form-row {
                display: flex;
                gap: 20px;
                margin-bottom: 20px;
            }

            .form-group {
                flex: 1;
            }

            .form-group.full-width {
                flex: 1 1 100%;
            }

            .form-label {
                display: block;
                margin-bottom: 8px;
                font-weight: 500;
                color: #333;
                font-size: 14px;
            }

            .form-input {
                width: 100%;
                padding: 12px 15px;
                border: 1px solid #eee;
                border-radius: 6px;
                font-size: 14px;
                outline: none;
                transition: border-color 0.3s ease;
            }

            .form-input:focus {
                border-color: #5cd8c4;
            }

            .form-select {
                width: 100%;
                padding: 12px 15px;
                border: 1px solid #eee;
                border-radius: 6px;
                font-size: 14px;
                outline: none;
                cursor: pointer;
                background-color: white;
                transition: border-color 0.3s ease;
            }

            .form-select:focus {
                border-color: #5cd8c4;
            }

            .form-textarea {
                width: 100%;
                padding: 12px 15px;
                border: 1px solid #eee;
                border-radius: 6px;
                font-size: 14px;
                outline: none;
                resize: vertical;
                min-height: 100px;
                transition: border-color 0.3s ease;
            }

            .form-textarea:focus {
                border-color: #5cd8c4;
            }

            .discount-type-section {
                background-color: #f8f9fa;
                padding: 20px;
                border-radius: 6px;
                margin-bottom: 20px;
            }

            .discount-type-title {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 15px;
                color: #333;
            }

            .discount-type-options {
                display: flex;
                gap: 15px;
                margin-bottom: 15px;
            }

            .radio-group {
                display: flex;
                align-items: center;
                cursor: pointer;
            }

            .radio-group input[type="radio"] {
                margin-right: 8px;
                accent-color: #5cd8c4;
            }

            .radio-group label {
                font-size: 14px;
                cursor: pointer;
                color: #333;
            }

            .conditional-field {
                margin-top: 15px;
            }

            .current-value {
                background-color: #e6f9f7;
                color: #5cd8c4;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 500;
                margin-left: 10px;
            }

            .form-actions {
                display: flex;
                gap: 15px;
                justify-content: flex-end;
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid #eee;
            }

            .btn-primary {
                background-color: #5cd8c4;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                font-weight: 500;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s ease;
            }

            .btn-primary:hover {
                background-color: #4ac7b3;
                transform: translateY(-2px);
            }

            .btn-secondary {
                background-color: #777;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                font-weight: 500;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s ease;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
            }

            .btn-secondary:hover {
                background-color: #666;
                transform: translateY(-2px);
            }

            .error-message {
                color: #ff4343;
                font-size: 12px;
                margin-top: 5px;
            }

            .success-message {
                color: #43ff84;
                font-size: 12px;
                margin-top: 5px;
            }

            .form-hint {
                color: #777;
                font-size: 12px;
                margin-top: 5px;
            }

            .status-section {
                background-color: #f8f9fa;
                padding: 20px;
                border-radius: 6px;
                margin-bottom: 20px;
            }

            .status-title {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 15px;
                color: #333;
            }

            .status-options {
                display: flex;
                gap: 15px;
            }

            .usage-info {
                background-color: #fff4e6;
                padding: 15px;
                border-radius: 6px;
                margin-bottom: 20px;
            }

            .usage-title {
                font-size: 14px;
                font-weight: 600;
                margin-bottom: 10px;
                color: #ff9843;
            }

            .usage-stats {
                display: flex;
                gap: 20px;
                font-size: 14px;
                color: #666;
            }

            .usage-stat {
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .usage-stat strong {
                color: #333;
            }

            .hidden {
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="main-content">
            <div class="page-header">
                <div class="page-title">Edit Coupon</div>
                <a href="/admin/coupon" class="back-button"> <i>‚Üê</i> Back to Coupons </a>
            </div>

            <div class="form-container">
                <form id="editCouponForm" action="/admin/editCoupon/<%= coupon._id %>" method="POST">
                    <!-- Usage Information -->
                    <div class="usage-info">
                        <div class="usage-title">Current Usage Information</div>
                        <div class="usage-stats">
                            <div class="usage-stat">
                                <span>Times Used:</span>
                                <strong><%= coupon.userId?.length %></strong>
                            </div>
                            <div class="usage-stat">
                                <span>Limit:</span>
                                <strong><%= coupon.userLimit %></strong>
                            </div>
                            <%=console.log(coupon)%>
                            <div class="usage-stat">
                                <span>Created:</span>
                                <strong><%= new Date(coupon?.createdOn).toLocaleDateString() %></strong>
                            </div>
                        </div>
                    </div>

                    <!-- Basic Information -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="code" class="form-label">
                                Coupon Code
                                <span class="current-value">Current: <%= coupon.code %></span>
                            </label>
                            <input
                                type="text"
                                id="code"
                                name="code"
                                class="form-input"
                                value="<%= coupon.code %>"
                                required
                            />
                            <div class="form-hint">Must be unique and contain only letters, numbers, and underscores</div>
                        </div>

                        <div class="form-group">
                            <label for="userLimit" class="form-label">
                                Usage Limit
                                <span class="current-value">Current: <%= coupon.userLimit %></span>
                            </label>
                            <input
                                type="number"
                                id="userLimit"
                                name="userLimit"
                                class="form-input"
                                value="<%= coupon.userLimit %>"
                                min="1"
                                required
                            />
                            <div class="form-hint">Maximum number of times this coupon can be used</div>
                        </div>
                    </div>

                    <!-- Discount Type Section -->
                    <div class="discount-type-section">
                        <div class="discount-type-title">Discount Configuration</div>

                        <div class="discount-type-options">
                            <div class="radio-group">
                                <input type="radio" id="percentage" name="discountType" value="percentage" <%=
                                coupon.discountType === 'percentage' ? 'checked' : '' %>>
                                <label for="percentage">Percentage Discount</label>
                            </div>
                            <div class="radio-group">
                                <input type="radio" id="fixed" name="discountType" value="fixed" <%= coupon.discountType ===
                                'fixed' ? 'checked' : '' %>>
                                <label for="fixed">Fixed Amount Discount</label>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group conditional-field" id="percentageField">
                                <label for="discountPercentage" class="form-label">
                                    Discount Percentage (%) <% if (coupon.discountType === 'percentage') { %>
                                    <span class="current-value">Current: <%= coupon.discountPercentage %>%</span>
                                    <% } %>
                                </label>
                                <input
                                    type="number"
                                    id="discountPercentage"
                                    name="discountPercentage"
                                    class="form-input"
                                    value="<%= coupon.discountPercentage || '' %>"
                                    min="1"
                                    max="100"
                                    step="0.01"
                                />
                                <div class="form-hint">Enter percentage value (1-100)</div>
                            </div>

                            <div class="form-group conditional-field" id="fixedField">
                                <label for="offerPrice" class="form-label">
                                    Fixed Discount Amount (‚Çπ) <% if (coupon.discountType === 'fixed') { %>
                                    <span class="current-value">Current: ‚Çπ<%= coupon.offerPrice %></span>
                                    <% } %>
                                </label>
                                <input
                                    type="number"
                                    id="offerPrice"
                                    name="offerPrice"
                                    class="form-input"
                                    value="<%= coupon.offerPrice || '' %>"
                                    min="1"
                                    step="0.01"
                                />
                                <div class="form-hint">Enter fixed discount amount in rupees</div>
                            </div>
                        </div>
                    </div>

                    <!-- Purchase Limits -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="minimumPurchase" class="form-label">
                                Minimum Purchase Amount (‚Çπ)
                                <span class="current-value">Current: ‚Çπ<%= coupon.minimumPurchase %></span>
                            </label>
                            <input
                                type="number"
                                id="minimumPurchase"
                                name="minimumPurchase"
                                class="form-input"
                                value="<%= coupon.minimumPurchase %>"
                                min="0"
                                step="0.01"
                                required
                            />
                            <div class="form-hint">Minimum cart value required to use this coupon</div>
                        </div>

                        <div class="form-group">
                            <label for="maximumPurchase" class="form-label">
                                Maximum Purchase Amount (‚Çπ)
                                <span class="current-value">Current: ‚Çπ<%= coupon.maximumPurchase %></span>
                            </label>
                            <input
                                type="number"
                                id="maximumPurchase"
                                name="maximumPurchase"
                                class="form-input"
                                value="<%= coupon.maximumPurchase %>"
                                min="0"
                                step="0.01"
                                required
                            />
                            <div class="form-hint">Maximum cart value for this coupon to be applicable</div>
                        </div>
                    </div>

                    <!-- Validity Period -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="createdOn" class="form-label">
                                Valid From
                                <span class="current-value"
                                    >Current: <%= new Date(coupon.createdOn).toLocaleDateString() %></span
                                >
                            </label>
                            <input
                                type="date"
                                id="createdOn"
                                name="createdOn"
                                class="form-input"
                                value="<%= new Date(coupon.createdOn).toISOString().split('T')[0] %>"
                                required
                            />
                            <div class="form-hint">Date when the coupon becomes active</div>
                        </div>

                        <div class="form-group">
                            <label for="expireOn" class="form-label">
                                Valid Until
                                <span class="current-value"
                                    >Current: <%= new Date(coupon.expireOn).toLocaleDateString() %></span
                                >
                            </label>
                            <input
                                type="date"
                                id="expireOn"
                                name="expireOn"
                                class="form-input"
                                value="<%= new Date(coupon.expireOn).toISOString().split('T')[0] %>"
                                required
                            />
                            <div class="form-hint">Date when the coupon expires</div>
                        </div>
                    </div>

                    <!-- Status Section -->
                    <div class="status-section">
                        <div class="status-title">Coupon Status</div>
                        <div class="status-options">
                            <div class="radio-group">
                                <input type="radio" id="active" name="status" value="active" <%= coupon.status === 'active'
                                ? 'checked' : '' %>>
                                <label for="active">Active</label>
                            </div>
                            <div class="radio-group">
                                <input type="radio" id="inactive" name="status" value="inactive" <%= coupon.status ===
                                'inactive' ? 'checked' : '' %>>
                                <label for="inactive">Inactive</label>
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="description" class="form-label">Description (Optional)</label>
                            <textarea
                                id="description"
                                name="description"
                                class="form-textarea"
                                placeholder="Enter coupon description..."
                            >
<%= coupon.description || '' %></textarea
                            >
                            <div class="form-hint">Brief description of the coupon offer</div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <a href="/admin/coupons" class="btn-secondary">Cancel</a>
                        <button type="submit" class="btn-primary">Update Coupon</button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            // Toggle discount type fields
            function toggleDiscountFields() {
                const discountType = document.querySelector('input[name="discountType"]:checked').value;
                const percentageField = document.getElementById("percentageField");
                const fixedField = document.getElementById("fixedField");

                if (discountType === "percentage") {
                    percentageField.classList.remove("hidden");
                    fixedField.classList.add("hidden");
                    document.getElementById("discountPercentage").required = true;
                    document.getElementById("offerPrice").required = false;
                } else {
                    fixedField.classList.remove("hidden");
                    percentageField.classList.add("hidden");
                    document.getElementById("offerPrice").required = true;
                    document.getElementById("discountPercentage").required = false;
                }
            }

            // Initialize on page load
            document.addEventListener("DOMContentLoaded", function () {
                toggleDiscountFields();

                // Add event listeners
                document.querySelectorAll('input[name="discountType"]').forEach((radio) => {
                    radio.addEventListener("change", toggleDiscountFields);
                });
            });

            // Form validation
            document.getElementById("editCouponForm").addEventListener("submit", async function (e) {
                e.preventDefault();
                const couponCode = document.getElementById("code").value;
                const discountType = document.querySelector('input[name="discountType"]:checked').value;
                const discountValue =
                    discountType === "percentage"
                        ? document.getElementById("discountPercentage").value
                        : document.getElementById("offerPrice").value;
                const minPurchase = document.getElementById("minimumPurchase").value;
                const maxPurchase = document.getElementById("maximumPurchase").value;
                const usageLimit = document.getElementById("userLimit").value;
                const validFrom = document.getElementById("createdOn").value;
                const validTo = document.getElementById("expireOn").value;
                const description = document.getElementById("description").value;
               const status = document.querySelector('input[name="status"]:checked').value;


                // Validation
                if (!couponCode || couponCode.length < 3) {
                    return Swal.fire("Invalid", "Coupon code must be at least 3 characters long", "error");
                }

                if (!discountValue || isNaN(discountValue) || discountValue <= 0) {
                    return Swal.fire("Invalid", "Discount value must be a positive number", "error");
                }

                if (discountType === "percentage" && (discountValue <= 0 || discountValue > 100)) {
                    return Swal.fire("Invalid", "Percentage must be between 1 and 100", "error");
                }

                if (!minPurchase || isNaN(minPurchase) || minPurchase < 0) {
                    return Swal.fire("Invalid", "Minimum purchase must be a positive number", "error");
                }

                if (maxPurchase && (isNaN(maxPurchase) || maxPurchase <= 0)) {
                    return Swal.fire("Invalid", "Maximum purchase must be a positive number", "error");
                }

                if (maxPurchase && parseFloat(minPurchase) > parseFloat(maxPurchase)) {
                    return Swal.fire("Error", "Minimum purchase cannot be greater than maximum purchase", "error");
                }

                if (!usageLimit || isNaN(usageLimit) || usageLimit <= 0) {
                    return Swal.fire("Invalid", "Usage limit must be a positive number", "error");
                }

                if (!validFrom || !validTo) {
                    return Swal.fire("Missing", "Valid From and Valid To dates are required", "error");
                }

                if (new Date(validFrom) >= new Date(validTo)) {
                    return Swal.fire("Invalid", "'Valid From' date must be before 'Valid To' date", "error");
                }

                // Prepare data
                const data = {
                    code: couponCode,
                    discountType: discountType,
                    discountPercentage: discountType === "percentage" ? parseFloat(discountValue) : null,
                    offerPrice: discountType === "fixed" ? parseFloat(discountValue) : null,
                    minimumPurchase: parseFloat(minPurchase),
                    maximumPurchase: maxPurchase ? parseFloat(maxPurchase) : parseFloat(minPurchase) * 10,
                    userLimit: parseInt(usageLimit),
                    createdOn: new Date(),
                    expireOn: new Date(validTo),
                    description: description || "",
                    status,
                };
                console.log(data);
                const coupoun_id = "<%= coupon._id.toString() %>";
                try {
                    const response = await fetch(`/admin/editCoupon/${coupoun_id}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data),
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        Swal.fire({
                            icon: "success",
                            title: "Success!",
                            text: result.message || "Coupon created successfully",
                            confirmButtonColor: "#28a745",
                            showConfirmButton: false,
                            timer: 2000,
                        }).then(() => {
                            window.location.href = "/admin/coupon";
                        });
                    } else {
                        Swal.fire({
                            icon: "error",
                            title: "Error",
                            text: result.message || "Something went wrong",
                            confirmButtonColor: "#d33",
                        });
                    }
                } catch (error) {
                    console.error("Error:", error);
                    Swal.fire({
                        icon: "error",
                        title: "Server Error",
                        text: "Something went wrong on the server. Please try again.",
                        confirmButtonColor: "#d33",
                    });
                }
            });

            // Initialize preview
        </script>
    </body>
</html>
