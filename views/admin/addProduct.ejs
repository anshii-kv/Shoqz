<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Product - Validation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css" rel="stylesheet">
    <style>
        .crop-container {
            margin: 10px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
            max-width: 300px;
        }
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            display: none;
        }
        .size-stock-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .form-control.is-invalid {
            border-color: #dc3545;
        }
        .loading {
            pointer-events: none;
            opacity: 0.6;
        }
        .gradient-text {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #182f95 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        .error-message {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 0.25rem;
            font-weight: 500;
        }
    </style>
</head>
<body style="background: linear-gradient(135deg, #fff 0%, #764ba2 100%);">
    <div class="container mt-4">
        <div class="card">
            <div class="card-header">
                <h3 class="gradient-text">Add New Product</h3>
            </div>
            <div class="card-body">
                <form id="product-form" enctype="multipart/form-data">
                    <!-- Product Name -->
                    <div class="mb-3">
                        <label for="productName" class="form-label">Product Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="productName" name="productName" placeholder="Enter product name">
                        <div id="productName-error" class="error-message" style="display: none;"></div>
                    </div>

                    <!-- Product Description -->
                    <div class="mb-3">
                        <label for="productDescription" class="form-label">Product Description <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="productDescription" name="productDescription" rows="4" placeholder="Enter product description"></textarea>
                        <div id="description-error" class="error-message" style="display: none;"></div>
                    </div>

                    <!-- Price -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productPrice" class="form-label">Sale Price <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="productPrice" name="productPrice" step="0.01" min="0" placeholder="0.00">
                                <div id="price-error" class="error-message" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="originalPrice" class="form-label">Original Price <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="originalPrice" name="originalPrice" step="0.01" min="0" placeholder="0.00">
                                <div id="originalPrice-error" class="error-message" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Category -->
                    <div class="mb-3">
                        <label for="category" class="form-label">Category <span class="text-danger">*</span></label>
                        <select class="form-select" id="category" name="category">
                            <option value="">Select a category</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Clothing">Clothing</option>
                            <option value="Books">Books</option>
                            <option value="Home">Home & Garden</option>
                            <option value="Sports">Sports</option>
                        </select>
                        <div id="category-error" class="error-message" style="display: none;"></div>
                    </div>

                    <!-- Size and Stock -->
                    <div class="mb-3">
                        <label class="form-label">Size & Stock <span class="text-danger">*</span></label>
                        <div id="sizeContainer">
                            <div class="size-stock-row">
                                <input type="text" name="size" class="form-control size-input" placeholder="Size" style="width: 120px;">
                                <input type="number" name="stock" class="form-control stock-input" placeholder="Stock" min="1" style="width: 120px;">
                                <button type="button" class="btn btn-danger remove-size-stock">Remove</button>
                            </div>
                        </div>
                        <button type="button" id="addSizeStockBtn" class="btn btn-secondary mt-2">Add Size & Stock</button>
                        <div id="sizeStock-error" class="error-message" style="display: none;"></div>
                    </div>

                    <!-- Product Images -->
                    <div class="mb-3">
                        <label for="productImages" class="form-label">Product Images <span class="text-danger">*</span> <small>(Minimum 3 images)</small></label>
                        <input type="file" class="form-control" id="productImages" name="productImages" multiple accept="image/*">
                        <div id="images-error" class="error-message" style="display: none;"></div>
                        <input type="hidden" id="croppedImages" name="croppedImages" value="">
                    </div>

                    <!-- Image Crop Container -->
                    <div id="imageCropContainer" class="mb-3" style="display: flex; flex-wrap: wrap;"></div>

                    <!-- Submit Button -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">Add Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.32/sweetalert2.all.min.js"></script>

    <script>
        let croppers = [];
        let isSubmitting = false;

        // Add size and stock functionality
        document.getElementById("addSizeStockBtn").addEventListener("click", function() {
            const sizeContainer = document.getElementById("sizeContainer");
            const sizeStockRow = document.createElement("div");
            sizeStockRow.classList.add("size-stock-row");
            sizeStockRow.innerHTML = `
                <input type="text" name="size" class="form-control size-input" placeholder="Size" style="width: 120px;">
                <input type="number" name="stock" class="form-control stock-input" placeholder="Stock" min="1" style="width: 120px;">
                <button type="button" class="btn btn-danger remove-size-stock">Remove</button>
            `;
            sizeContainer.appendChild(sizeStockRow);
        });

        // Remove size and stock functionality
        document.getElementById("sizeContainer").addEventListener("click", function(e) {
            if (e.target.classList.contains("remove-size-stock")) {
                const rows = document.querySelectorAll(".size-stock-row");
                if (rows.length > 1) {
                    e.target.closest(".size-stock-row").remove();
                } else {
                    showToast("At least one size and stock is required!");
                }
            }
        });

        // Image handling and cropping
        document.getElementById("productImages").addEventListener("change", function(event) {
            const files = event.target.files;
            
            if (files.length < 3) {
                displayError("images-error", "Please select at least 3 images");
                addInvalidClass("productImages");
                return;
            }

            const container = document.getElementById("imageCropContainer");
            container.innerHTML = "";

            // Destroy existing croppers
            croppers.forEach(cropper => {
                if (cropper) cropper.destroy();
            });
            croppers = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();

                const cropContainer = document.createElement("div");
                cropContainer.classList.add("crop-container");

                const imagePreview = document.createElement("img");
                imagePreview.classList.add("image-preview");
                imagePreview.id = `imagePreview_${i}`;

                const cropButton = document.createElement("button");
                cropButton.type = "button";
                cropButton.classList.add("btn", "btn-secondary", "mt-2");
                cropButton.textContent = "Crop Image";
                cropButton.id = `cropButton_${i}`;

                cropContainer.appendChild(imagePreview);
                cropContainer.appendChild(cropButton);
                container.appendChild(cropContainer);

                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = "block";

                    const cropper = new Cropper(imagePreview, {
                        aspectRatio: 1,
                        viewMode: 1,
                        autoCropArea: 1,
                    });
                    croppers[i] = cropper;

                    cropButton.addEventListener("click", function() {
                        const canvas = cropper.getCroppedCanvas({
                            width: 500,
                            height: 500
                        });
                        const croppedImage = canvas.toDataURL("image/jpeg");

                        let croppedImagesField = document.getElementById("croppedImages").value;
                        croppedImagesField = croppedImagesField ? JSON.parse(croppedImagesField) : [];
                        
                        // Update or add cropped image
                        if (croppedImagesField[i]) {
                            croppedImagesField[i] = croppedImage;
                        } else {
                            croppedImagesField.push(croppedImage);
                        }
                        
                        document.getElementById("croppedImages").value = JSON.stringify(croppedImagesField);
                        
                        // Update UI to show image is cropped
                        cropButton.textContent = "âœ“ Image Cropped";
                        cropButton.classList.remove("btn-secondary");
                        cropButton.classList.add("btn-success");
                        
                        showToast("Image cropped successfully!", 'success');
                    });
                };

                reader.readAsDataURL(file);
            }
            
            // Clear image error if files are selected
            removeError("images-error");
            removeInvalidClass("productImages");
        });

        function validateForm() {
            const name = document.getElementById("productName")?.value.trim();
            const description = document.getElementById("productDescription")?.value.trim();
            const price = document.getElementById("productPrice")?.value.trim();
            const originalPrice = document.getElementById("originalPrice")?.value.trim();
            const category = document.getElementById("category")?.value.trim();
            
            clearAllErrors();
            let isValid = true;
            
            // Validate product name
            if (!name) {
                displayError("productName-error", "Product name is required");
                addInvalidClass("productName");
                isValid = false;
            } else if (name.length < 3) {
                displayError("productName-error", "Product name must be at least 3 characters long");
                addInvalidClass("productName");
                isValid = false;
            } else if (!/^[A-Za-z0-9\s'-]+$/.test(name)) {
                displayError("productName-error", "Product name can only contain letters, numbers, spaces, hyphens, and apostrophes");
                addInvalidClass("productName");
                isValid = false;
            }
            
            // Validate description
            if (!description) {
                displayError("description-error", "Product description is required");
                addInvalidClass("productDescription");
                isValid = false;
            } else if (description.length < 10) {
                displayError("description-error", "Description must be at least 10 characters long");
                addInvalidClass("productDescription");
                isValid = false;
            }
            
            // Validate price
            if (!price) {
                displayError("price-error", "Sale price is required");
                addInvalidClass("productPrice");
                isValid = false;
            } else if (isNaN(price) || parseFloat(price) <= 0) {
                displayError("price-error", "Please enter a valid price greater than 0");
                addInvalidClass("productPrice");
                isValid = false;
            }
            
            // Validate original price
            if (!originalPrice) {
                displayError("originalPrice-error", "Original price is required");
                addInvalidClass("originalPrice");
                isValid = false;
            } else if (isNaN(originalPrice) || parseFloat(originalPrice) <= 0) {
                displayError("originalPrice-error", "Please enter a valid original price greater than 0");
                addInvalidClass("originalPrice");
                isValid = false;
            } else if (price && parseFloat(originalPrice) < parseFloat(price)) {
                displayError("originalPrice-error", "Original price must be greater than or equal to sale price");
                addInvalidClass("originalPrice");
                isValid = false;
            }
            
            // Validate category
            if (!category) {
                displayError("category-error", "Please select a category");
                addInvalidClass("category");
                isValid = false;
            }
            
            // Validate sizes and stock
            const sizes = document.querySelectorAll('input[name="size"]');
            const stocks = document.querySelectorAll('input[name="stock"]');
            
            let hasValidSize = false;
            let sizeStockErrors = [];
            
            for (let i = 0; i < sizes.length; i++) {
                const size = sizes[i].value.trim();
                const stock = stocks[i].value.trim();
                
                if (!size && !stock) {
                    continue;
                } else if (!size) {
                    sizeStockErrors.push(`Row ${i + 1}: Size is required`);
                } else if (!stock || isNaN(stock) || parseInt(stock) <= 0) {
                    sizeStockErrors.push(`Row ${i + 1}: Valid stock quantity is required`);
                } else {
                    hasValidSize = true;
                }
            }
            
            if (!hasValidSize) {
                displayError("sizeStock-error", "Please add at least one valid size and stock combination");
                isValid = false;
            } else if (sizeStockErrors.length > 0) {
                displayError("sizeStock-error", sizeStockErrors.join(', '));
                isValid = false;
            }
            
            // Validate images
            const croppedImages = document.getElementById("croppedImages").value;
            if (!croppedImages) {
                displayError("images-error", "Please select and crop at least 3 images");
                addInvalidClass("productImages");
                isValid = false;
            } else {
                try {
                    const croppedImagesArray = JSON.parse(croppedImages);
                    if (croppedImagesArray.length < 3) {
                        displayError("images-error", "Please crop at least 3 images");
                        addInvalidClass("productImages");
                        isValid = false;
                    }
                } catch (e) {
                    displayError("images-error", "Invalid image data");
                    addInvalidClass("productImages");
                    isValid = false;
                }
            }
            
            return isValid;
        }
        
        function clearAllErrors() {
            const errorElements = document.querySelectorAll('.error-message');
            errorElements.forEach(element => {
                element.style.display = 'none';
                element.textContent = '';
            });
            
            const invalidElements = document.querySelectorAll('.is-invalid');
            invalidElements.forEach(element => {
                element.classList.remove('is-invalid');
            });
        }
        
        function displayError(id, message) {
            const errorElement = document.getElementById(id);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }
        
        function removeError(id) {
            const errorElement = document.getElementById(id);
            if (errorElement) {
                errorElement.style.display = 'none';
                errorElement.textContent = '';
            }
        }
        
        function addInvalidClass(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.classList.add('is-invalid');
            }
        }
        
        function removeInvalidClass(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.classList.remove('is-invalid');
            }
        }

        function dataURItoBlob(dataURI) {
            const byteString = atob(dataURI.split(",")[1]);
            const mimeString = dataURI.split(",")[0].split(":")[1].split(";")[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            
            return new Blob([ab], { type: mimeString });
        }

        function showToast(message, type = 'error') {
            const backgroundColor = type === 'success' ? "#28a745" : "#dc3545";
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: backgroundColor,
                stopOnFocus: true,
            }).showToast();
        }

        // Form submission
        document.getElementById("product-form").addEventListener("submit", function(e) {
            e.preventDefault();
            
            if (isSubmitting) {
                return;
            }
            
            if (!validateForm()) {
                showToast("Please fix the errors above before submitting");
                return;
            }
            
            Swal.fire({
                title: "Are you sure?",
                text: "Do you want to add this product?",
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "#28a745",
                cancelButtonColor: "#dc3545",
                confirmButtonText: "Yes, add it!"
            }).then((result) => {
                if (result.isConfirmed) {
                    submitForm();
                }
            });
        });
        
        async function submitForm() {
            if (isSubmitting) {
                return;
            }
            
            isSubmitting = true;
            const submitBtn = document.getElementById("submitBtn");
            const form = document.getElementById("product-form");
            
            submitBtn.textContent = "Adding Product...";
            submitBtn.disabled = true;
            form.classList.add("loading");
            
            try {
                const formData = new FormData();
                
                const name = document.getElementById("productName").value.trim();
                const description = document.getElementById("productDescription").value.trim();
                const price = document.getElementById("productPrice").value.trim();
                const originalPrice = document.getElementById("originalPrice").value.trim();
                const category = document.getElementById("category").value.trim();
                const croppedImages = JSON.parse(document.getElementById("croppedImages").value);

                formData.append("name", name);
                formData.append("description", description);
                formData.append("price", price);
                formData.append("originalPrice", originalPrice);
                formData.append("category", category);
                
                // Collect size and stock data
                const sizeStockData = [];
                const sizes = document.querySelectorAll('input[name="size"]');
                const stocks = document.querySelectorAll('input[name="stock"]');
                
                for (let i = 0; i < sizes.length; i++) {
                    const size = sizes[i].value.trim();
                    const stock = stocks[i].value.trim();
                    
                    if (size && stock) {
                        sizeStockData.push({ size, stock: parseInt(stock) });
                    }
                }
                
                formData.append("availableSize", JSON.stringify(sizeStockData));
                
                // Process cropped images
                croppedImages.forEach((image, index) => {
                    const blob = dataURItoBlob(image);
                    formData.append(`croppedImages`, blob, `croppedImage_${index}.jpg`);
                });
                
                // Since we can't make actual HTTP requests in this demo, we'll simulate success
                showToast("Product added successfully!", 'success');
                
                // Reset form after successful submission
                setTimeout(() => {
                    document.getElementById("product-form").reset();
                    document.getElementById("croppedImages").value = "";
                    document.getElementById("imageCropContainer").innerHTML = "";
                    clearAllErrors();
                    showToast("Form has been reset for demo purposes", 'success');
                }, 1500);
                
            } catch (error) {
                console.error("Error:", error);
                showToast("An error occurred while adding the product.");
            } finally {
                isSubmitting = false;
                submitBtn.textContent = "Add Product";
                submitBtn.disabled = false;
                form.classList.remove("loading");
            }
        }

        // Real-time validation
        document.getElementById("productName").addEventListener("blur", function() {
            const value = this.value.trim();
            if (!value) {
                displayError("productName-error", "Product name is required");
                addInvalidClass("productName");
            } else if (value.length < 3) {
                displayError("productName-error", "Product name must be at least 3 characters long");
                addInvalidClass("productName");
            } else if (!/^[A-Za-z0-9\s'-]+$/.test(value)) {
                displayError("productName-error", "Product name can only contain letters, numbers, spaces, hyphens, and apostrophes");
                addInvalidClass("productName");
            } else {
                removeError("productName-error");
                removeInvalidClass("productName");
            }
        });

        document.getElementById("productDescription").addEventListener("blur", function() {
            const value = this.value.trim();
            if (!value) {
                displayError("description-error", "Product description is required");
                addInvalidClass("productDescription");
            } else if (value.length < 10) {
                displayError("description-error", "Description must be at least 10 characters long");
                addInvalidClass("productDescription");
            } else {
                removeError("description-error");
                removeInvalidClass("productDescription");
            }
        });

        document.getElementById("productPrice").addEventListener("blur", function() {
            const value = this.value.trim();
            if (!value) {
                displayError("price-error", "Sale price is required");
                addInvalidClass("productPrice");
            } else if (isNaN(value) || parseFloat(value) <= 0) {
                displayError("price-error", "Please enter a valid price greater than 0");
                addInvalidClass("productPrice");
            } else {
                removeError("price-error");
                removeInvalidClass("productPrice");
                const originalPrice = document.getElementById("originalPrice").value.trim();
                if (originalPrice && parseFloat(originalPrice) < parseFloat(value)) {
                    displayError("originalPrice-error", "Original price must be greater than or equal to sale price");
                    addInvalidClass("originalPrice");
                }
            }
        });

        document.getElementById("originalPrice").addEventListener("blur", function() {
            const value = this.value.trim();
            const salePrice = document.getElementById("productPrice").value.trim();
            if (!value) {
                displayError("originalPrice-error", "Original price is required");
                addInvalidClass("originalPrice");
            } else if (isNaN(value) || parseFloat(value) <= 0) {
                displayError("originalPrice-error", "Please enter a valid original price greater than 0");
                addInvalidClass("originalPrice");
            } else if (salePrice && parseFloat(value) < parseFloat(salePrice)) {
                displayError("originalPrice-error", "Original price must be greater than or equal to sale price");
                addInvalidClass("originalPrice");
            } else {
                removeError("originalPrice-error");
                removeInvalidClass("originalPrice");
            }
        });

        document.getElementById("category").addEventListener("change", function() {
            const value = this.value.trim();
            if (!value) {
                displayError("category-error", "Please select a category");
                addInvalidClass("category");
            } else {
                removeError("category-error");
                removeInvalidClass("category");
            }
        });

        document.getElementById("sizeContainer").addEventListener("blur", function(e) {
            if (e.target.matches('input[name="size"], input[name="stock"]')) {
                validateSizeStock();
            }
        }, true);

        function validateSizeStock() {
            const sizes = document.querySelectorAll('input[name="size"]');
            const stocks = document.querySelectorAll('input[name="stock"]');
            
            let hasValidSize = false;
            
            for (let i = 0; i < sizes.length; i++) {
                const size = sizes[i].value.trim();
                const stock = stocks[i].value.trim();
                
                if (size && stock && parseInt(stock) > 0) {
                    hasValidSize = true;
                    break;
                }
            }
            
            if (!hasValidSize) {
                displayError("sizeStock-error", "Please add at least one valid size and stock combination");
            } else {
                removeError("sizeStock-error");
            }
        }
    </script>
</body>
</html>